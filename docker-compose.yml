services:
  # Neo4j Database
  neo4j:
    image: neo4j:5.15-community
    container_name: clash-royale-neo4j
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    environment:
      - NEO4J_AUTH=neo4j/clash_royale_kg_2025
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_server_memory_pagecache_size=512M
      - NEO4J_server_memory_heap_initial__size=512M
      - NEO4J_server_memory_heap_max__size=1G
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_import:/var/lib/neo4j/import
      - neo4j_plugins:/plugins
    networks:
      - rag-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s

  # RAG Application (untuk ingestion)
  rag-ingestion:
    build: .
    container_name: clash-royale-ingestion
    depends_on:
      neo4j:
        condition: service_healthy
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=clash_royale_kg_2025
      - LLM_MODEL=Qwen/Qwen2.5-1.5B-Instruct
      - LLM_DEVICE=cpu
      - LLM_MAX_TOKENS=512
      - LLM_TEMPERATURE=0.1
      - VERBOSE=false
    volumes:
      - ./data:/app/data
      - model_cache:/root/.cache/huggingface
    networks:
      - rag-network
    command: >
      sh -c "
        echo '‚è≥ Menunggu Neo4j siap...' &&
        sleep 10 &&
        echo 'üìä Memulai ingestion data...' &&
        python -m src.kg.ingestion &&
        echo '‚úÖ Ingestion selesai! Database sudah siap.' &&
        echo 'üí° Jalankan: docker-compose run --rm rag-cli' &&
        echo '   untuk menggunakan sistem RAG.'
      "

  # RAG CLI Application
  rag-cli:
    build: .
    container_name: clash-royale-rag-cli
    depends_on:
      - neo4j
    environment:
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=clash_royale_kg_2025
      - LLM_MODEL=Qwen/Qwen2.5-1.5B-Instruct
      - LLM_DEVICE=cpu
      - LLM_MAX_TOKENS=512
      - LLM_TEMPERATURE=0.1
      - VERBOSE=false
    volumes:
      - ./data:/app/data
      - model_cache:/root/.cache/huggingface
    networks:
      - rag-network
    stdin_open: true
    tty: true
    profiles:
      - cli  # Only start when explicitly requested

volumes:
  neo4j_data:
    name: clash_royale_neo4j_data
  neo4j_logs:
    name: clash_royale_neo4j_logs
  neo4j_import:
    name: clash_royale_neo4j_import
  neo4j_plugins:
    name: clash_royale_neo4j_plugins
  model_cache:
    name: clash_royale_model_cache

networks:
  rag-network:
    name: clash_royale_network
    driver: bridge
